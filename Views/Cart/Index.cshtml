@{
    ViewData["Title"] = "Твоята количка";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 cart-page">
    <h2 class="text-danger fw-bold mb-3">Твоята количка</h2>
    <p class="text-muted">
                          .
    </p>

    <div id="cart-empty" class="alert alert-info d-none">
        Количката е празна. Добави продукти от каталога.
    </div>

    <div id="cart-wrapper">
        <table class="table cart-table align-middle">
            <thead class="table-light">
                <tr>
                    <th>Продукт</th>
                    <th class="text-center">Размери (мм)</th>
                    <th class="text-center">Цвят</th>
                    <th class="text-center">Площ (м²)</th>
                    <th class="text-end">Цена (лв.)</th>
                    <th class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody id="cart-body">
                @* редовете ще се добавят от JS *@
            </tbody>
            <tfoot class="table-light">
                <tr>
                    <th colspan="3" class="text-end">Общо:</th>
                    <th class="text-center" id="cart-total-area">0.000</th>
                    <th class="text-end" id="cart-total-price">0.00 лв.</th>
                    <th></th>
                </tr>
            </tfoot>
        </table>

        <div class="d-flex justify-content-between mt-3 cart-actions-row">
            <button id="clearCartBtn" class="btn btn-outline-secondary">
                Изчисти количката
            </button>

            <a asp-controller="Cart" asp-action="Order" class="btn btn-danger">
                Продължи към заявка
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Взимаме количката от localStorage
        function getCart() {
            try {
                const raw = localStorage.getItem("tk_cart");
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                return [];
            }
        }

        function setCart(cart) {
            localStorage.setItem("tk_cart", JSON.stringify(cart));
            // обновяваме броя в иконката горе
            if (typeof updateCartCount === "function") {
                updateCartCount();
            }
        }

        function renderCart() {
            const cart = getCart();
            const body = document.getElementById("cart-body");
            const empty = document.getElementById("cart-empty");
            const wrapper = document.getElementById("cart-wrapper");
            const totalAreaCell = document.getElementById("cart-total-area");
            const totalPriceCell = document.getElementById("cart-total-price");

            body.innerHTML = "";

            if (cart.length === 0) {
                empty.classList.remove("d-none");
                wrapper.classList.add("d-none");
                totalAreaCell.textContent = "0.000";
                totalPriceCell.textContent = "0.00 лв.";
                return;
            }

            empty.classList.add("d-none");
            wrapper.classList.remove("d-none");

            let totalArea = 0;
            let totalPrice = 0;

            cart.forEach((item, index) => {
                const tr = document.createElement("tr");

                const sizeText = `${item.heightMm} x ${item.widthMm}`;
                const areaText = (item.areaM2 || 0).toFixed(3);
                const priceText = (item.totalPrice || 0).toFixed(2);

                totalArea += item.areaM2 || 0;
                totalPrice += item.totalPrice || 0;

                tr.innerHTML = `
                    <td>${item.name || ""}</td>
                    <td class="text-center">${sizeText}</td>
                    <td class="text-center">${item.variantColor || "-"}</td>
                    <td class="text-center">${areaText}</td>
                    <td class="text-end">${priceText} лв.</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger cart-remove-btn"
                                data-index="${index}">
                            Премахни
                        </button>
                    </td>
                `;

                body.appendChild(tr);
            });

            totalAreaCell.textContent = totalArea.toFixed(3);
            totalPriceCell.textContent = totalPrice.toFixed(2) + " лв.";

            // закачаме събития за премахване
            document.querySelectorAll(".cart-remove-btn").forEach(btn => {
                btn.addEventListener("click", function () {
                    const idx = parseInt(this.getAttribute("data-index"));
                    removeFromCart(idx);
                });
            });
        }

        function removeFromCart(index) {
            const cart = getCart();
            if (index >= 0 && index < cart.length) {
                cart.splice(index, 1);
                setCart(cart);
                renderCart();
            }
        }

        function clearCart() {
            if (!confirm("Сигурен ли си, че искаш да изчистиш количката?")) return;
            setCart([]);
            renderCart();
        }

        document.addEventListener("DOMContentLoaded", function () {
            renderCart();

            const clearBtn = document.getElementById("clearCartBtn");
            if (clearBtn) {
                clearBtn.addEventListener("click", clearCart);
            }
        });
    </script>
}
